<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Panel Admin - Tienda de Caf√©</title>
  <link rel="stylesheet" href="/css/menu.css">
  <link rel="icon" type="image/png" href="/img/cafe del sol.png">
</head>

<body>
  <!-- ======== ENCABEZADO ======== -->
  <header>
    <div class="nav-container">
      <div class="logo">
        <img src="/img/cafe del sol.png" alt="Logo Caf√© del Sol">
        <h1>Caf√© del Sol</h1>
      </div>
      <nav>
        <a href="/inicio.html" class="active">Inicio</a>
        <a href="/inicio.html">Inicio</a>
        <a href="/menu.html">Men√∫</a>
        <a href="/adicionales.html">Adicionales</a>
        <a href="/promos.html">Promociones</a>
        <button id="logoutBtn" class="logout">Cerrar sesi√≥n</button>
      </nav>
    </div>
  </header>

  <!-- ======== CONTENIDO PRINCIPAL ======== -->
  <main>
    <h2>Panel de Administraci√≥n</h2>

    <section id="ventas">
      <h3>Registro de Ventas</h3>
      <button id="refreshVentas" class="btn btn-edit">Actualizar</button>
      <div id="tablaVentas"></div>
    </section>
  </main>

  <!-- ======== PIE DE P√ÅGINA PROMOCIONAL ======== -->
  <footer class="promo-footer">
    <h3>¬°Gracias por administrar con pasi√≥n el mejor caf√©!</h3>
    <p>Recuerda revisar los pedidos pendientes y mantener el sabor del √©xito ‚òï</p>
    <div class="promo-icons">
      <img src="/img/coffee-icon1.png" alt="icono caf√©">
      <img src="/img/coffee-icon2.png" alt="icono grano">
      <img src="/img/coffee-icon3.png" alt="icono taza">
    </div>
  </footer>

  <!-- ======== SCRIPT PRINCIPAL ======== -->
  <script>
  // --- Verificar sesi√≥n ---
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || user.role !== 'admin') {
    alert('Acceso restringido: solo administradores.');
    location.href = '/login.html';
  }

  // --- Mostrar ventas ---
  async function cargarVentas() {
    const cont = document.getElementById('tablaVentas');
    cont.innerHTML = '<p>Cargando ventas...</p>';

    const res = await fetch('/api/admin/orders');
    const j = await res.json();

    if (!j.ok) {
      cont.innerHTML = '<p class="error">‚ùå No se pudieron cargar las ventas.</p>';
      return;
    }

    if (!j.orders.length) {
      cont.innerHTML = '<p>No hay ventas registradas a√∫n.</p>';
      return;
    }

    const rows = j.orders.map(o => `
  <tr class="fila-datos">
    <td>${o.id}</td>
    <td>${o.cliente}</td>
    <td>$${Number(o.total).toFixed(2)}</td>
    <td>
      <select onchange="actualizarEstado(${o.id}, this.value)">
        <option value="pendiente" ${o.status === 'pendiente' ? 'selected' : ''}>Pendiente</option>
        <option value="pagado" ${o.status === 'pagado' ? 'selected' : ''}>Pagado</option>
        <option value="enviado" ${o.status === 'enviado' ? 'selected' : ''}>Enviado</option>
        <option value="cancelado" ${o.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
      </select>
    </td>
    <td>${new Date(o.created_at).toLocaleString()}</td>
    <td>
      <button class="btn btn-print" onclick="imprimirFactura(${o.id})">üßæ Imprimir</button>
    </td>
  </tr>
`).join('');

   cont.innerHTML = `
  <table class="tabla-datos">
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Fecha</th>
        <th>Factura</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  </table>
`;

  }

  document.getElementById('refreshVentas').addEventListener('click', cargarVentas);
  cargarVentas();

  // --- Actualizar estado ---
  async function actualizarEstado(id, nuevoEstado) {
    const confirmar = confirm(`¬øCambiar el estado del pedido #${id} a "${nuevoEstado}"?`);
    if (!confirmar) return;

    const res = await fetch(`/api/orders/${id}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: nuevoEstado })
    });

    const data = await res.json();
    if (data.ok) {
      alert(data.message);
      cargarVentas();
    } else {
      alert('Error: ' + data.message);
    }
  }

  // --- Logout ---
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await fetch('/api/logout', { method: 'POST' });
    localStorage.removeItem('user');
    location.href = '/';
  });
  </script>
</body>
</html>
